{% extends "base.html" %}

{% block content %}
<!-- Header Section -->
<div class="row justify-content-center mb-4">
    <div class="col-md-10 text-center">
        <div class="mt-4 mb-4">
            <h1 class="display-5">Portfolio Performance Leaderboard</h1>
            <p class="lead">Track and compare portfolio performance across all users</p>
            
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-lg mt-3">
                    <i class="fas fa-tachometer-alt me-2"></i>Go to Dashboard
                </a>
            {% else %}
                <a href="{{ url_for('login') }}" class="btn btn-primary btn-lg mt-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Get Started
                </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Embedded Leaderboard -->
<div class="row justify-content-center">
    <div class="col-md-12">
        <div id="leaderboard-content">
            <!-- This will be populated by JavaScript -->
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading leaderboard...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load leaderboard content on page load
document.addEventListener('DOMContentLoaded', function() {
    loadLeaderboard();
});

function loadLeaderboard() {
    fetch('/leaderboard/api/data?period=YTD&limit=10')
        .then(response => response.json())
        .then(data => {
            if (data.data && data.data.length > 0) {
                let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
                html += '<th>Rank</th><th>User</th><th>Performance</th><th>Portfolio Value</th><th>Market Cap Focus</th></tr></thead><tbody>';
                
                data.data.forEach((entry, index) => {
                    const marketCapFocus = entry.small_cap_percent > 50 ? 'Small Cap' : 
                                         entry.large_cap_percent > 50 ? 'Large Cap' : 'Mixed';
                    html += `<tr>
                        <td>${index + 1}</td>
                        <td>${entry.username}</td>
                        <td class="${entry.performance_percent >= 0 ? 'text-success' : 'text-danger'}">
                            ${entry.performance_percent >= 0 ? '+' : ''}${entry.performance_percent.toFixed(2)}%
                        </td>
                        <td>$${entry.portfolio_value.toLocaleString()}</td>
                        <td>${marketCapFocus}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                html += '<div class="text-center mt-3"><a href="/leaderboard/" class="btn btn-primary">View Full Leaderboard</a></div>';
                
                document.getElementById('leaderboard-content').innerHTML = html;
            } else {
                document.getElementById('leaderboard-content').innerHTML = '<p class="text-center">No leaderboard data available yet. Check back after market close for updated rankings.</p>';
            }
        })
        .catch(error => {
            console.error('Error loading leaderboard:', error);
            document.getElementById('leaderboard-content').innerHTML = '<p class="text-center text-muted">Leaderboard data will be available after market close. Please check back later.</p>';
        });
}

// Auto-refresh leaderboard data once daily at 8:30 PM EST (after market close)
function scheduleNextRefresh() {
    const now = new Date();
    const refreshTime = new Date();
    refreshTime.setHours(20, 30, 0, 0); // 8:30 PM
    
    // If it's already past 8:30 PM today, schedule for tomorrow
    if (now > refreshTime) {
        refreshTime.setDate(refreshTime.getDate() + 1);
    }
    
    const timeUntilRefresh = refreshTime.getTime() - now.getTime();
    setTimeout(() => {
        loadLeaderboard();
        scheduleNextRefresh(); // Schedule the next refresh
    }, timeUntilRefresh);
}

// Start the daily refresh schedule
scheduleNextRefresh();
</script>
{% endblock %}
